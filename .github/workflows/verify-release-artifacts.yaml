# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

name: Verify Release Artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: The x.y.z version (also need to specify applicable suffixes like +ent and -dev)'
        required: true
        type: string
      include-fips:
        description: Indicates whether we should check for FIPS binaries and docker images. Versions below 1.16.0 should be false.
        required: false
        type: boolean
        default: true

jobs:
  verify-oss-docker-images:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # NOTE: this permission is explicitly required for Vault auth.
      contents: read
    steps:
      # NOTE: ENT specific step as we store secrets in Vault.
      - name: Authenticate to Vault
        if: ${{ endsWith(github.repository, '-enterprise') }}
        id: vault-auth
        run: vault-auth

      # NOTE: ENT specific step as we store secrets in Vault.
      - name: Fetch Secrets
        if: ${{ endsWith(github.repository, '-enterprise') }}
        id: secrets
        uses: hashicorp/vault-action@v2.5.0
        with:
          url: ${{ steps.vault-auth.outputs.addr }}
          caCertificate: ${{ steps.vault-auth.outputs.ca_certificate }}
          token: ${{ steps.vault-auth.outputs.token }}
          secrets: |
            kv/data/github/${{ github.repository }}/dockerhub username | DOCKERHUB_USERNAME;
            kv/data/github/${{ github.repository }}/dockerhub token | DOCKERHUB_TOKEN;

      # NOTE: conditional specific logic as we store secrets in Vault in ENT and use GHA secrets in OSS.
      - name: Login to Docker Hub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a # v2.1.0
        with:
          username: ${{ endsWith(github.repository, '-enterprise') && steps.secrets.outputs.DOCKERHUB_USERNAME || secrets.DOCKERHUB_USERNAME }}
          password: ${{ endsWith(github.repository, '-enterprise') && steps.secrets.outputs.DOCKERHUB_TOKEN || secrets.DOCKERHUB_TOKEN }}

      - name: docker pull OSS - docker hub
        run: docker pull hashicorp/consul:${{ inputs.version }}
      - name: docker pull OSS - ECR
        run: docker pull public.ecr.aws/hashicorp/consul:${{ inputs.version }}
  verify-ent-docker-images:
    runs-on: ubuntu-latest
    steps:
      - name: docker pull ENT - docker hub
        run: docker pull hashicorp/consul-enterprise:${{ inputs.version }}-ent
      - name: docker pull ENT - ECR
        run: docker pull public.ecr.aws/hashicorp/consul-enterprise:${{ inputs.version }}-ent
  verify-fips-docker-images:
    runs-on: ubuntu-latest
    steps:
      - name: docker pull ENT FIPS - docker hub
        run: docker pull hashicorp/consul-enterprise:${{ inputs.version }}-ent.fips1402
      - name: docker pull ENT FIPS - ECR
        run: docker pull public.ecr.aws/hashicorp/consul-enterprise:${{ inputs.version }}-ent.fips1402

